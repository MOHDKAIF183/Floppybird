<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Floppy Bird</title>

<link rel="shortcut icon"
href="https://raw.githubusercontent.com/ImKennyYip/flappy-bird/master/flappybird.png">

<style>
body{
    margin:0;
    background:#222;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}
#board{
    background-image:url("https://raw.githubusercontent.com/ImKennyYip/flappy-bird/master/flappybirdbg.png");
    background-size:cover;
    background-position:center;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
    max-width:100%;
    max-height:80vh;
}
</style>
</head>

<body>
<canvas id="board"></canvas>

<script>
let board;
let context;

let boardWidth = 1280;
let boardHeight = 640;

let bird = {
    x: boardWidth / 8,
    y: boardHeight / 2,
    width: 34,
    height: 24
};

let birdImg, topPipeImg, bottomPipeImg;

let pipeArray = [];
let pipeWidth = 64;
let pipeHeight = 512;

let velocityX = -2;
let velocityY = 0;
let gravity = 0.4;

let score = 0;
let bestScore = Number(localStorage.getItem("bestScore")) || 0;
let gameOver = false;

// âœ… track completed pipe pairs
let passedPairs = new Set();

window.onload = () => {
    board = document.getElementById("board");
    board.width = boardWidth;
    board.height = boardHeight;
    context = board.getContext("2d");

    birdImg = new Image();
    birdImg.src = "https://raw.githubusercontent.com/ImKennyYip/flappy-bird/master/flappybird.png";

    topPipeImg = new Image();
    topPipeImg.src = "https://raw.githubusercontent.com/ImKennyYip/flappy-bird/master/toppipe.png";

    bottomPipeImg = new Image();
    bottomPipeImg.src = "https://raw.githubusercontent.com/ImKennyYip/flappy-bird/master/bottompipe.png";

    requestAnimationFrame(update);
    setInterval(placePipes, 1500);

    document.addEventListener("keydown", moveBird);
    document.addEventListener("click", moveBird);
    document.addEventListener("touchstart", moveBird);
};

function update(){
    requestAnimationFrame(update);
    if(gameOver) return;

    context.clearRect(0,0,board.width,board.height);

    velocityY += gravity;
    bird.y += velocityY;

    context.drawImage(birdImg, bird.x, bird.y, bird.width, bird.height);

    if(bird.y > boardHeight){
        endGame();
    }

    for(let pipe of pipeArray){
        pipe.x += velocityX;
        context.drawImage(pipe.img, pipe.x, pipe.y, pipe.width, pipe.height);

        // mark pipe passed
        if(!pipe.passed && bird.x > pipe.x + pipe.width){
            pipe.passed = true;

            // check if both pipes of this pair are passed
            let pairPipes = pipeArray.filter(p => p.pairId === pipe.pairId);
            let bothPassed = pairPipes.every(p => p.passed);

            if(bothPassed && !passedPairs.has(pipe.pairId)){
                score++;
                passedPairs.add(pipe.pairId);
            }
        }

        if(collision(bird, pipe)){
            endGame();
        }
    }

    pipeArray = pipeArray.filter(p => p.x > -pipeWidth);

    context.fillStyle = "black";
    context.font = "40px Arial";
    context.fillText(score, 10, 45);
}

function placePipes(){
    if(gameOver) return;

    let randomY = -pipeHeight/2 - Math.random()*200;
    let opening = board.height / 4;

    let pairId = Date.now() + Math.random();

    pipeArray.push({
        img: topPipeImg,
        x: boardWidth,
        y: randomY,
        width: pipeWidth,
        height: pipeHeight,
        pairId: pairId,
        passed: false
    });

    pipeArray.push({
        img: bottomPipeImg,
        x: boardWidth,
        y: randomY + pipeHeight + opening,
        width: pipeWidth,
        height: pipeHeight,
        pairId: pairId,
        passed: false
    });
}

function moveBird(e){
    if(!e.code || e.code === "Space" || e.code === "ArrowUp"){
        velocityY = -6;

        if(gameOver){
            resetGame();
        }
    }
}

function collision(a,b){
    return a.x < b.x + b.width &&
           a.x + a.width > b.x &&
           a.y < b.y + b.height &&
           a.y + a.height > b.y;
}

function endGame(){
    gameOver = true;
    bestScore = Math.max(bestScore, score);
    localStorage.setItem("bestScore", bestScore);

    context.fillText("Khel khatam", 10, 100);
    context.fillText("Best: " + bestScore, 10, 150);

}

function resetGame(){
    bird.y = boardHeight / 2;
    velocityY = 0;
    pipeArray = [];
    passedPairs.clear();
    score = 0;
    gameOver = false;
}
</script>
</body>
</html>
